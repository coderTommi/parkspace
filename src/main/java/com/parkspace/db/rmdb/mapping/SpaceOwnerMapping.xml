<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.parkspace.db.rmdb.dao.SpaceOwnerDao">
	<!-- 物业车位信息字段-->
	<sql id="Space_Owner_Column">
		s.spaceno,s.isauth,s.carno
	</sql>
	<!-- 用户信息字段 -->
	<sql id="Baseuser_Column">
		u.userId,u.userName,u.nickName,u.telephone,u.isAdmin,u.idtype,u.idno,u.state,u.weixinAccount,u.avator,u.memo,u.createBy,u.createTime,u.modifyBy,u.modifyTime
	</sql>
	<!-- 车位信息字段 -->
	<sql id="Parking_Space_Column">
		p.comid,p.parkPositionFloor,p.parkPositionZone,p.parkPositionX,p.parkPositionY,p.parkStatus,p.parkType,p.parkPositionDes,p.spaceOwner
	</sql>
	<!-- 小区信息字段 -->
	<sql id="Community_Column">
		c.zoneid,c.comname,c.address,c.isenable
	</sql>
	<!-- 行政区域信息字段 -->
	<sql id="Zone_Column">
		z.zonename,z.isenable as zoneisenable,z.province,z.city,z.zone
	</sql>
	
	<!-- 根据车位编号获取车位业主信息 -->
	<select id="getSpaceOwner" parameterType="string" resultType="SpaceOwner">
		select 
			<include refid="Space_Owner_Column"/>,
			<include refid="Baseuser_Column"/>
		from SpaceOwner s,Baseuser u
		where s.userId  = u.userId
		and   s.spaceno = #{spaceno}
	</select>
	<!-- 保存车位业主信息 -->
	<insert id="addSpaceOwner" parameterType="SpaceOwner">
    	insert into SpaceOwner(
				spaceno,
				userId,
				isauth,
				carno
    		) 
         values(
       			#{spaceno},
       			#{userId},
       			#{isauth},
       			#{carno}
         )
	</insert>
	
	<!-- 更改车位业主信息 -->
	<update id="updateSpaceOwner" parameterType="SpaceOwner">
    	update SpaceOwner set
    			userId     = #{userId},
    			isauth     = #{isauth},
    			carno      = #{carno}
    	where   spaceno = #{spaceno}
	</update>
	
	<!-- 删除车位业主信息,修改isauth为-1,需要同时更新编辑人和编辑时间 -->
	<update id="deleteSpaceOwner" parameterType="SpaceOwner">
    	update SpaceOwner set
    			isauth   = -1
    	where spaceno = #{spaceno}
	</update>
	<!-- 根据条件查询车位业主信息 -->
	<select id="getSpaceOwnerList" parameterType="SpaceOwner" resultType="SpaceOwner">
		select 
				<include refid="Space_Owner_Column"/>,
				<include refid="Baseuser_Column"/>
		from SpaceOwner s , Baseuser u
		where s.userId = u.userId
			 <!-- 车主信息过滤 -->
			 <if test="spaceno != null">
            	<!-- and spaceno = #{spaceno} -->
            	and s.spaceno like CONCAT('%', #{spaceno}, '%') 
        	 </if>
        	 <if test="isauth != null">
            	and s.isauth = #{isauth}
        	 </if>
        	 <if test="carno != null">
            	and s.carno like CONCAT('%', #{carno}, '%') 
        	 </if>
        	 <!-- 用户基本信息过滤 -->
        	 <if test="userId != null">
            	and u.userId = #{userId}
        	 </if>
        	 <if test="createTime != null">
            	<![CDATA[ and u.createTime >= #{createTime} ]]>
        	 </if>
        	 order by u.createTime desc
	</select>
	<!-- 根据条件查询车位业主信息，信息包括 -->
	<!-- 车位信息、小区信息、行政区域信息、用户基本信息等 -->
	<select id="getSpaceOwnerAllInfoList" parameterType="SpaceOwner" resultType="SpaceOwner">
		select 
			<include refid="Space_Owner_Column" />
			,
			<include refid="Baseuser_Column" />
			,
			<include refid="Parking_Space_Column"/>
			,
			<include refid="Community_Column"/>
			,
			<include refid="Zone_Column"/>
		from SpaceOwner s,
		     Baseuser u,
		     ParkingSpace p,
		     Community c,
			 Zone z
		where 1=1
		      and s.userId  = u.userId
		      and s.spaceno = p.spaceno
		      and p.comid   = c.comid
		      and c.zoneid  = z.zoneid
		      
		      <!-- 车位业主过滤条件 -->
		      <if test="spaceno != null">
		      	<!-- and spaceno = #{spaceno} -->
		      	 and s.spaceno like CONCAT('%', #{spaceno}, '%') 
        	  </if>
        	  <if test="userId != null">
            	 and s.userId = #{userId}
        	  </if>
        	  <if test="isauth != null">
            	 and s.isauth = #{isauth}
        	  </if>
        	  <!-- 业主多状态查询 -->
        	  <if test="isauthQuery != null and isauthQuery.length > 0 ">
        	  	 and s.isauth in
        	  	 	<foreach item="item" index="index" collection="isauthQuery" open="(" separator="," close=")">  
 						#{item}  
					</foreach>
        	  </if>
        	  <if test="carno != null">
            	 and s.carno like CONCAT('%', #{carno}, '%') 
        	  </if>
        	  <!-- 用户信息过滤 -->
        	  <if test="userName != null">
            	 and u.userName like CONCAT('%', #{userName}, '%') 
        	  </if>
        	  <if test="nickName != null">
            	 and u.nickName like CONCAT('%', #{nickName}, '%') 
        	  </if>
        	  <if test="state != null">
            	 and u.state = #{state}
        	  </if>
        	  <if test="createTime != null">
            	 <![CDATA[ and u.createTime >= #{createTime} ]]>
        	  </if>
        	  <!-- 车位信息过滤 -->
        	  <if test="comid != null">
            	 and p.comid = #{comid}
        	  </if>
        	  <if test="parkPositionFloor != null">
            	 and p.parkPositionFloor = #{parkPositionFloor}
        	  </if>
        	  <if test="parkPositionZone != null">
            	 and p.parkPositionZone = #{parkPositionZone}
        	  </if>
        	  <if test="parkPositionX != null">
            	 and p.parkPositionX = #{parkPositionX}
        	  </if>
        	  <if test="parkPositionY != null">
            	 and p.parkPositionY = #{parkPositionY}
        	  </if>
        	  <if test="parkStatus != null">
            	 and p.parkStatus = #{parkStatus}
        	  </if>
        	  <if test="parkType != null">
            	 and p.parkType = #{parkType}
        	  </if>
        	 
        	  <if test="parkPositionDes != null">
            	 and p.parkPositionDes like CONCAT('%', #{parkPositionDes}, '%') 
        	  </if>
        	  <if test="spaceOwner != null">
            	 and p.spaceOwner = #{spaceOwner}
        	  </if>
        	  <!-- 小区过滤条件 -->
        	  <if test="zoneid != null">
            	 and c.zoneid = #{zoneid}
        	  </if>
        	  <if test="comname != null">
            	 and c.comname like CONCAT('%', #{comname}, '%')  
        	  </if>
        	  <if test="address != null">
            	 and c.address like CONCAT('%', #{address}, '%') 
        	  </if>
        	  <if test="isenable != null">
            	 and c.isenable = #{isenable}
        	  </if>
        	  <!-- 小区多状态查询 -->
        	  <if test="isenableQuery != null and isenableQuery.length > 0 ">
        	  	 and c.isenable in
        	  	 	<foreach item="item" index="index" collection="isenableQuery" open="(" separator="," close=")">  
 						#{item}  
					</foreach>
        	  </if>
        	  <!-- 行政区域过滤条件 -->
        	  <if test="zonename != null">
            	 and z.zonename like CONCAT('%', #{zonename}, '%') 
        	  </if>
        	  <if test="zoneisenable != null">
            	 and z.isenable = #{zoneisenable}
        	  </if>
        	  <!-- 行政区域多状态查询 -->
        	  <if test="zoneIsenableQuery != null and zoneIsenableQuery.length > 0 ">
        	  	 and z.isenable in
        	  	 	<foreach item="item" index="index" collection="zoneIsenableQuery" open="(" separator="," close=")">  
 						#{item}  
					</foreach>
        	  </if>
        	  <if test="province != null">
            	 and z.province = #{province}
        	  </if>
        	  <if test="city != null">
            	 and z.city = #{city}
        	  </if>
        	  <if test="zone != null">
            	 and z.zone = #{zone}
        	  </if>
        order by u.createTime desc
	</select>
</mapper>